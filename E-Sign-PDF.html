<!DOCTYPE html>
<html lang="en">
<head>
<link rel="icon" href="favicon-16x16.png" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>eSign PDF Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0;
            min-height: 600px;
        }

        .upload-section {
            padding: 40px;
            background: #f8faff;
            border-right: 1px solid #e9ecef;
        }

        .preview-section {
            padding: 40px;
            background: white;
            position: relative;
        }

        .file-upload {
            border: 3px dashed #007bff;
            border-radius: 15px;
            padding: 40px 20px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload:hover {
            border-color: #0056b3;
            background: rgba(0, 123, 255, 0.05);
        }

        .file-upload.dragover {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }

        .upload-icon {
            font-size: 3rem;
            color: #007bff;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .signature-section {
            margin-top: 30px;
        }

        .signature-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab-button {
            flex: 1;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            color: #6c757d;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            color: #007bff;
            border-bottom-color: #007bff;
            font-weight: 600;
        }

        .tab-content {
            display: none;
            padding: 20px 0;
        }

        .tab-content.active {
            display: block;
        }

        .signature-canvas-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            height: 200px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            overflow: hidden;
        }

        .signature-canvas {
            display: block;
            width: 100%;
            height: 100%;
            cursor: crosshair;
            touch-action: none;
        }

        .signature-text-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            font-size: 1.5rem;
            font-family: 'Brush Script MT', cursive;
            text-align: center;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #1e7e34;
        }

        .btn:disabled {
            background: #dee2e6;
            color: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        .pdf-preview {
            border: 2px solid #dee2e6;
            border-radius: 10px;
            width: 100%;
            height: 400px;
            overflow: auto;
            background: #f8f9fa;
            position: relative;
            cursor: crosshair;
        }

        .pdf-page {
            margin: 0 auto;
            display: block;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        .signature-placeholder {
            position: absolute;
            border: 2px dashed #007bff;
            background: rgba(0, 123, 255, 0.1);
            border-radius: 5px;
            display: none;
            pointer-events: none;
        }

        .placement-instructions {
            text-align: center;
            color: #6c757d;
            margin-bottom: 20px;
            font-style: italic;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
            display: none;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .header p {
                font-size: 1rem;
            }

            .main-content {
                grid-template-columns: 1fr;
            }

            .upload-section,
            .preview-section {
                padding: 20px;
            }

            .file-upload {
                padding: 30px 15px;
            }

            .upload-icon {
                font-size: 2rem;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                min-width: auto;
            }

            .signature-canvas-container {
                height: 150px;
            }

            .pdf-preview {
                height: 300px;
            }

            .container {
                margin: 10px;
                border-radius: 15px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .header {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .upload-section,
            .preview-section {
                padding: 15px;
            }

            .signature-text-input {
                font-size: 1.2rem;
            }
        }

        /* Touch improvements for mobile */
        @media (pointer: coarse) {
            .signature-canvas {
                cursor: default;
            }
            
            .pdf-preview {
                cursor: default;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìù eSign PDF Tool</h1>
            <p>Upload, Sign, and Download your PDFs with ease</p>
        </div>

        <div class="main-content">
            <div class="upload-section">
                <div class="file-upload" onclick="document.getElementById('pdfInput').click()">
                    <div class="upload-icon">üìÑ</div>
                    <h3>Upload PDF Document</h3>
                    <p>Click here or drag & drop your PDF file</p>
                    <input type="file" id="pdfInput" class="file-input" accept="application/pdf">
                </div>

                <div class="signature-section">
                    <h3>Create Your Signature</h3>
                    
                    <div class="signature-tabs">
                        <button class="tab-button active" data-tab="draw">‚úèÔ∏è Draw</button>
                        <button class="tab-button" data-tab="type">‚å®Ô∏è Type</button>
                    </div>

                    <div class="tab-content active" id="draw-tab">
                        <div class="signature-canvas-container">
                            <canvas id="signatureCanvas" class="signature-canvas"></canvas>
                        </div>
                        <div class="button-group">
                            <button class="btn btn-secondary" id="clearBtn">Clear</button>
                        </div>
                    </div>

                    <div class="tab-content" id="type-tab">
                        <input type="text" id="signatureText" class="signature-text-input" placeholder="Type your signature here">
                        <div class="button-group">
                            <button class="btn btn-secondary" id="clearTextBtn">Clear</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="preview-section">
                <h3>Document Preview</h3>
                <div class="placement-instructions" id="instructions">
                    Upload a PDF to preview and click where you want to place your signature
                </div>
                
                <div class="pdf-preview" id="pdfPreview">
                    <canvas id="pdfCanvas" class="pdf-page" style="display: none;"></canvas>
                    <div class="signature-placeholder" id="signaturePlaceholder"></div>
                </div>

                <div class="success-message" id="successMessage">
                    ‚úÖ Signature placed successfully! You can now download your signed PDF.
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" id="placeSignatureBtn" disabled>Place Signature</button>
                    <button class="btn btn-success" id="downloadBtn" disabled>Download PDF</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://unpkg.com/pdfjs-dist@3.4.120/build/pdf.min.js"></script>
    <script>
        class ESignTool {
            constructor() {
                this.initializeElements();
                this.initializeSignaturePad();
                this.initializeEventListeners();
                this.pdfDoc = null;
                this.signaturePosition = null;
                this.currentSignature = null;
                this.signatureType = 'draw';
                this.isDrawing = false;
                this.lastX = 0;
                this.lastY = 0;
            }

            initializeElements() {
                this.pdfInput = document.getElementById('pdfInput');
                this.signatureCanvas = document.getElementById('signatureCanvas');
                this.signatureText = document.getElementById('signatureText');
                this.pdfPreview = document.getElementById('pdfPreview');
                this.pdfCanvas = document.getElementById('pdfCanvas');
                this.signaturePlaceholder = document.getElementById('signaturePlaceholder');
                this.clearBtn = document.getElementById('clearBtn');
                this.clearTextBtn = document.getElementById('clearTextBtn');
                this.placeSignatureBtn = document.getElementById('placeSignatureBtn');
                this.downloadBtn = document.getElementById('downloadBtn');
                this.instructions = document.getElementById('instructions');
                this.successMessage = document.getElementById('successMessage');
                this.fileUpload = document.querySelector('.file-upload');
            }

            initializeSignaturePad() {
                const canvas = this.signatureCanvas;
                const container = canvas.parentElement;
                
                // Set canvas size to match container
                this.resizeCanvas();
                
                const ctx = canvas.getContext('2d');
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;

                // Mouse events
                canvas.addEventListener('mousedown', this.startDrawing.bind(this));
                canvas.addEventListener('mousemove', this.draw.bind(this));
                canvas.addEventListener('mouseup', this.stopDrawing.bind(this));
                canvas.addEventListener('mouseout', this.stopDrawing.bind(this));

                // Touch events for mobile
                canvas.addEventListener('touchstart', this.handleTouchStart.bind(this));
                canvas.addEventListener('touchmove', this.handleTouchMove.bind(this));
                canvas.addEventListener('touchend', this.stopDrawing.bind(this));
                canvas.addEventListener('touchcancel', this.stopDrawing.bind(this));

                // Prevent scrolling when touching the canvas
                canvas.addEventListener('touchstart', (e) => e.preventDefault(), { passive: false });
                canvas.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
            }

            resizeCanvas() {
                const canvas = this.signatureCanvas;
                const container = canvas.parentElement;
                const rect = container.getBoundingClientRect();
                
                // Set canvas size to match container exactly
                canvas.width = rect.width;
                canvas.height = rect.height;
                
                // Reset context properties after resize
                const ctx = canvas.getContext('2d');
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.strokeStyle = '#000000';
                ctx.lineWidth = 2;
            }

            getEventPos(e) {
                const canvas = this.signatureCanvas;
                const rect = canvas.getBoundingClientRect();
                
                let clientX, clientY;
                
                if (e.touches && e.touches.length > 0) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                
                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            }

            startDrawing(e) {
                this.isDrawing = true;
                const pos = this.getEventPos(e);
                this.lastX = pos.x;
                this.lastY = pos.y;
                
                // Draw a dot for single clicks
                const ctx = this.signatureCanvas.getContext('2d');
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, 1, 0, 2 * Math.PI);
                ctx.fill();
            }

            draw(e) {
                if (!this.isDrawing) return;

                const ctx = this.signatureCanvas.getContext('2d');
                const pos = this.getEventPos(e);

                ctx.beginPath();
                ctx.moveTo(this.lastX, this.lastY);
                ctx.lineTo(pos.x, pos.y);
                ctx.stroke();

                this.lastX = pos.x;
                this.lastY = pos.y;

                this.updatePlaceSignatureButton();
            }

            handleTouchStart(e) {
                e.preventDefault();
                this.startDrawing(e);
            }

            handleTouchMove(e) {
                e.preventDefault();
                this.draw(e);
            }

            stopDrawing() {
                if (this.isDrawing) {
                    this.isDrawing = false;
                    this.updatePlaceSignatureButton();
                }
            }

            initializeEventListeners() {
                // File upload
                this.pdfInput.addEventListener('change', this.handleFileUpload.bind(this));
                
                // Drag and drop
                this.fileUpload.addEventListener('dragover', this.handleDragOver.bind(this));
                this.fileUpload.addEventListener('drop', this.handleDrop.bind(this));
                this.fileUpload.addEventListener('dragleave', this.handleDragLeave.bind(this));

                // Tab switching
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', this.switchTab.bind(this));
                });

                // Clear buttons
                this.clearBtn.addEventListener('click', this.clearSignature.bind(this));
                this.clearTextBtn.addEventListener('click', this.clearTextSignature.bind(this));

                // PDF preview click
                this.pdfPreview.addEventListener('click', this.handlePreviewClick.bind(this));

                // Signature text input
                this.signatureText.addEventListener('input', this.updateTextSignature.bind(this));

                // Buttons
                this.placeSignatureBtn.addEventListener('click', this.placeSignature.bind(this));
                this.downloadBtn.addEventListener('click', this.downloadSignedPDF.bind(this));

                // Window resize
                window.addEventListener('resize', this.resizeCanvas.bind(this));
            }

            switchTab(e) {
                const tabName = e.target.dataset.tab;
                this.signatureType = tabName;

                // Update active tab
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                e.target.classList.add('active');
                document.getElementById(`${tabName}-tab`).classList.add('active');

                this.updatePlaceSignatureButton();
            }

            handleFileUpload(e) {
                const file = e.target.files[0];
                if (file && file.type === 'application/pdf') {
                    this.loadPDF(file);
                }
            }

            handleDragOver(e) {
                e.preventDefault();
                this.fileUpload.classList.add('dragover');
            }

            handleDrop(e) {
                e.preventDefault();
                this.fileUpload.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                if (file && file.type === 'application/pdf') {
                    this.pdfInput.files = e.dataTransfer.files;
                    this.loadPDF(file);
                }
            }

            handleDragLeave(e) {
                this.fileUpload.classList.remove('dragover');
            }

            async loadPDF(file) {
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    this.pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer);

                    // Also load with PDF.js for preview
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    const page = await pdf.getPage(1);
                    
                    const viewport = page.getViewport({ scale: 1.5 });
                    const canvas = this.pdfCanvas;
                    const context = canvas.getContext('2d');
                    
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    canvas.style.display = 'block';

                    await page.render({
                        canvasContext: context,
                        viewport: viewport
                    }).promise;

                    this.instructions.textContent = 'Click on the document where you want to place your signature';
                    this.updatePlaceSignatureButton();

                } catch (error) {
                    alert('Error loading PDF: ' + error.message);
                }
            }

            clearSignature() {
                const ctx = this.signatureCanvas.getContext('2d');
                ctx.clearRect(0, 0, this.signatureCanvas.width, this.signatureCanvas.height);
                this.updatePlaceSignatureButton();
            }

            clearTextSignature() {
                this.signatureText.value = '';
                this.updatePlaceSignatureButton();
            }

            updateTextSignature() {
                this.updatePlaceSignatureButton();
            }

            handlePreviewClick(e) {
                if (!this.pdfCanvas.style.display || this.pdfCanvas.style.display === 'none') return;

                const rect = this.pdfCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                // Convert to PDF coordinates
                this.signaturePosition = {
                    x: (x / rect.width) * this.pdfCanvas.width,
                    y: (y / rect.height) * this.pdfCanvas.height
                };

                // Show placeholder
                this.showSignaturePlaceholder(x, y);
            }

            showSignaturePlaceholder(x, y) {
                const placeholder = this.signaturePlaceholder;
                placeholder.style.display = 'block';
                placeholder.style.left = x - 75 + 'px';
                placeholder.style.top = y - 25 + 'px';
                placeholder.style.width = '150px';
                placeholder.style.height = '50px';

                this.updatePlaceSignatureButton();
            }

            updatePlaceSignatureButton() {
                const hasSignature = this.signatureType === 'draw' ? 
                    this.hasDrawnSignature() : this.signatureText.value.trim() !== '';
                const hasPosition = this.signaturePosition !== null;
                const hasPDF = this.pdfDoc !== null;

                this.placeSignatureBtn.disabled = !(hasSignature && hasPosition && hasPDF);
            }

            hasDrawnSignature() {
                const canvas = this.signatureCanvas;
                const ctx = canvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                
                // Check if any pixel is not transparent
                for (let i = 3; i < imageData.data.length; i += 4) {
                    if (imageData.data[i] !== 0) {
                        return true;
                    }
                }
                return false;
            }

            async createSignatureImage() {
                if (this.signatureType === 'draw') {
                    return this.signatureCanvas.toDataURL('image/png');
                } else {
                    // Create text signature
                    const canvas = document.createElement('canvas');
                    canvas.width = 300;
                    canvas.height = 100;
                    const ctx = canvas.getContext('2d');
                    
                    // Clear canvas with transparent background
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    ctx.fillStyle = '#000';
                    ctx.font = '36px "Brush Script MT", cursive';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(this.signatureText.value, canvas.width / 2, canvas.height / 2);
                    
                    return canvas.toDataURL('image/png');
                }
            }

            async placeSignature() {
                try {
                    this.currentSignature = await this.createSignatureImage();
                    this.successMessage.style.display = 'block';
                    this.downloadBtn.disabled = false;
                    
                    // Hide placeholder
                    this.signaturePlaceholder.style.display = 'none';
                    
                    setTimeout(() => {
                        this.successMessage.style.display = 'none';
                    }, 3000);

                } catch (error) {
                    alert('Error creating signature: ' + error.message);
                }
            }

            async downloadSignedPDF() {
                try {
                    const pdfDoc = await PDFLib.PDFDocument.load(await this.pdfDoc.save());
                    
                    // Convert signature to PNG bytes
                    const pngImageBytes = this.currentSignature.split(',')[1];
                    const pngImage = await pdfDoc.embedPng(pngImageBytes);

                    const pages = pdfDoc.getPages();
                    const firstPage = pages[0];
                    const { width, height } = firstPage.getSize();

                    // Convert position from canvas coordinates to PDF coordinates
                    const pdfX = (this.signaturePosition.x / this.pdfCanvas.width) * width;
                    const pdfY = height - ((this.signaturePosition.y / this.pdfCanvas.height) * height);

                    firstPage.drawImage(pngImage, {
                        x: pdfX - 75,
                        y: pdfY - 25,
                        width: 150,
                        height: 50
                    });

                    const pdfBytes = await pdfDoc.save();
                    
                    // Download
                    const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'signed-document.pdf';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                } catch (error) {
                    alert('Error downloading PDF: ' + error.message);
                }
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            new ESignTool();
        });
    </script>
</body>
</html>
